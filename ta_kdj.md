# KDJ

随机指标（KDJ）由 George C. Lane 创建. 它综合了动量观念、强弱指标及移动平均线的优点, 用来度量股价脱离价格正常范围的变异程度. 该指标总共包含三根线, 分别是 K, D, J 线

假设收盘价 `CLOSE = {close_1, close_2,..., close_n}`，最高价 `HIGH = {high_1, high_2, ..., high_n}`，最低价 `LOW = {low_1, low_2, ..., low_n}`，则 kdj 计算如下

$$
lowest\_low_i = min\{low_{i-8},\ low_{i-7},\ ...,\ low_{i}\}
$$

$$
highest\_high_i = max\{high_{i-8},\ high_{i-7},\ ...,\ high_{i}\}
$$

$$
rsv_i = \frac{close_i - lowest\_low_i}{highest\_high_i - lowest\_low_i} \times 100
$$

$$
k_i = \frac{2}{3} \times k_{i-1} + \frac{1}{3} \times rsv_i,\ k_1=50
$$

$$
d_i = \frac{2}{3} \times d_{i-1} + \frac{1}{3} \times k_i,\ d_1=50
$$

$$
j_i = 3 \times k_i - 2 \times d_i
$$

代码实现

```py
# KDJ 代码实现
import pandas as pd

def calc_kdj(close, high, low) -> pd.DataFrame:
    """
    计算 KDJ
    """
    lowest_low = low.rolling(window=9, min_periods=1).min()
    highest_low = high.rolling(window=9, min_periods=1).max()
    rsv = (close - lowest_low) / (highest_low - lowest_low) * 100
    rsv = pd.Series(rsv, name='RSV')

    k, d, j = [], [], []
    for ele in rsv.array:
        if len(k) == 0:
            # 初始值50
            k.append(50)
            d.append(50)
            j.append(50)
            continue

        pre_k = k[-1]
        cur_k = (2 * pre_k + ele) / 3

        pre_d = d[-1]
        cur_d = (2 * pre_d + cur_k) / 3

        cur_j = 3 * cur_k - 2 * cur_d

        k.append(cur_k)
        d.append(cur_d)
        j.append(cur_j)

    k = pd.Series(k, name='K')
    d = pd.Series(d, name='D')
    j = pd.Series(j, name='J')

    df = pd.concat([k, d, j], axis=1)

    return df
```

根据 kdj 的计算公式，先来推算下取值范围。rsv 计算的分子是 _收盘价_（`close`） 减去 _窗口内的最低价_（`wins_min(low)`），分母是 _窗口内的最高价_ （`wins_max(high)`） 与 _窗口内的最低价_ 相减。分母代表窗口内最大波动范围，必然大于 0。分子收盘价 ≥ 窗口内的最低价。所以 rsv 的取值范围为 [0, 100]，k 利用 _昨日 k_ 平滑 rsv，d 利用 _昨日 d_ 平滑 k。由于 _初始 k_（`k1`）为 50 和 rsv 的取值范围为 [0, 100]，k 必然也是一个在[0, 100]内的数，因为 d 计算与 k 很类似，所以也是一样是[0, 100]内的数。而 j 是 三倍的 k 减去 两倍的 d，按照极限考虑，j 的最小取值为为 -200（`k=0, d=100`），最大取值为 300（`k=100, d=0`）。

一般情况下，j 的取值范围基本上在 -10~110 内波动，有时候会稍微超过 100 或稍微低至 0。以贵州茅台从 2001-08-27 ~ 2023-10-20 的数据来看，超过 100 的交易日占比 7%（`376/5373`），而低于 0 的交易日占比 7.5%（`403/5373`）。最高达到过 129.62（2006-04-19），最低到过 -31.24（2006-03-13）。所以拿两个例子来感受下计算过程，一个是 2023-07-25（`j=110.80`），另一个是 2023-10-19（`j=-2.60`）。

贵州茅台在 2023-07-25 的数据如下所示，股价快速攀升，j 值就会非常大。_窗口内 min(最低价)_ 为 `1713.80`， _窗口内 max(最高价)_ 为 `1828.88`。而当天收盘价为 `1828.55`，与 _窗口内 max(最高价)_ 仅仅有 3.3 毛钱的缺口。在这种情况下，rsv 就会非常大（`99.71`，`114.75/115.08`）。快线 k 在 _昨日 k_ 的基础上 加上 `1/3` 的 rsv，慢线 d 在 _昨日 d_ 的基础上 加上 `1/3` 的 k（即 对于 rsv 而言，仅仅取了 `1/9` ）。 j 用 3 倍快线（`263.71`）减去 2 倍慢线（`142.9`）等于 `110.80`。

```
   trade_date          K          D           J    close  lowest_low  highest_high        RSV
14 2023-07-21  66.595025  58.846389   82.092295  1771.30     1702.10       1772.50  98.295455
15 2023-07-24  76.994362  64.895713  101.191658  1771.15     1711.33       1772.50  97.793036
16 2023-07-25  84.567322  71.452916  110.796134  1828.55     1713.80       1828.88  99.713243
17 2023-07-26  87.681922  76.862585  109.320596  1828.55     1713.80       1835.99  93.911122
18 2023-07-27  87.825492  80.516887  102.442702  1838.03     1713.80       1854.79  88.112632
```

贵州茅台在 2023-10-19 的数据如下所示，当股价快速下跌，j 值会出现非常小的值（`-2.61`）。我们来看下具体情况，当天股价大幅下跌（收盘价 `1630.00`），并且窗口内最低价的最小值也在该天出现（_窗口内 min(最低价)_ `1626.03`），而 _窗口内 max(最高价)_ 为 `1798.98`。收盘价与 _窗口内 min(最低价)_ 之间只差了 `3.97` 块钱，而 _窗口内 max(最高价)_ 与 _窗口内 min(最低价)_ 之间却有 `172.95` 块钱的差距。所以计算出来的 rsv 值就非常小了（`2.30`，`3.97/172.95`）。所以，快线 k、慢线 d 都有不同程度的下降（k: `9.09`；d: `14.95`）。所以 按照公式 j 计算低于零值（`-2.60`）。

```
   trade_date          K        RSV      pre_k          D          J    close  lowest_low  highest_high
70 2023-10-17  13.243333   8.510638  15.609680  20.565948  -1.401897  1726.00     1716.00       1833.50
71 2023-10-18  12.499287  11.011195  13.243333  17.877061   1.743739  1728.00     1716.00       1824.98
72 2023-10-19   9.098012   2.295461  12.499287  14.950711  -2.607388  1630.00     1626.03       1798.98
73 2023-10-20  11.309873  15.733596   9.098012  13.737098   6.455422  1645.00     1616.25       1798.98
```

kdj 的关键就是 rsv 的计算，因为 k、d、j 这三个指标都是在 rsv 之上进行“平滑”处理。k 的计算是取了 `1/3` 的 rsv，而 d 在取了 `1/9` 的 rsv（`1/3` 的 k）， j 是 `7/9` 的 rsv （`3k-2d`）。rsv 成分越高，对当日股价变化就会更敏感，所以敏感程度由高到低为 j、k、d。敏感就意味着变化速度快，稳定性差，可靠性也越低。

rsv 可以看成是一个由 close 切分出两个线段 `a`，`b` 之间的比较（`a = wins_max(high)-close`、`b = close-wins_min(low)`，`rsv = b/(a+b)*100`）。那就会有三种情况：1. `a > b`（`rsv < 50`）说明 收盘价 离 _窗口内 min(最低价)_ 比较近，说明空方力量占优，大多数人都看空；2. `a < b`（`rsv > 50`）说明 收盘价 离 _窗口内 max(最高价)_ 比较近，说明多方力量占优，大多数人都看多；3. `a = b`（`rsv = 50`）说明 收盘价没有明显的偏向，空方和多方力量五五开。对于 k、d、j 也是如此。所以将 50 看成 零轴，另外还有两个比较特殊的区域，超买区（k>90，d>80），超卖区（k<10，d<20）。

当 j 线从零轴下突破 k 线和 d 线时，说明空方力量减弱，股价短期将向上，可以少量建仓。当 j 线向上穿越 k 线和 d 线之后，迅速向上运动，说明股价有一波较大的上涨行情，投资者可以考虑加仓或者持股待涨。当 j 线经过一段快速向上的运动之后，在超买区（k:90, d:80）向下掉头的时候，说明股价短期上涨过快，可能进入一波调整期，可以考虑减仓。当 k 线也开始从高位向下掉头的时候，说明中短期上涨行情已经结束，应该考虑清仓。当 k、d、j 三条线同时从高位向下，并且 j 线穿越 k 线和 d 线（kdj 死叉），说明必然股价下跌趋势形成，需要立刻清仓，并持币观望。具体交易逻辑总结如下。

- 底部，j 线拐头上翘，可以少量建仓 5%~10%
- 继续向上，kdj 底部形成金叉，建仓 20%~40%
- kdj 三条线继续向上运动，穿越零轴，加仓 20%~40%或持股待涨
- kdj 从高位形成死叉并同时向下，立刻清仓；kdj 三条线同时向下，立刻清仓！！

当股价 k 线图一浪比一浪高，而 kdj 在图形上整体是一浪比一浪低的走势，称之为顶背离。一般出现在高位，其内在逻辑在于股价虽然有所提升，但多方力量已经衰竭，有下跌趋势，建议卖出。当股价 k 线图一浪比一浪低，而 kdj 在图形上整体是一浪比一浪高走势，称之为底背离。一般出现在底部，说明空方力量衰竭，有上涨的趋势，建议买入。

KDJ 存在钝化问题，简单说就是当 kdj 处于超买和超卖区域时，股价依然活跃上涨或继续下跌时，指标上面并没有明显变化，甚至走出了相反的走势的现象，或者出现给出“假”金叉入场信号。解决办法 1：放大周期（3 日 kdj `wins=27`，最多 5 日 kdj `wins=45`，不能过大），如果未出现共振，则是假信号；方法 2：MACD 共振法；方法 3：K 线浪形法，由于 kdj 钝化在 K 线上的表现是上升波浪和下降波浪，比如在上升波浪中回调的时候，kdj 容易给出死叉信号，但该死叉信号是假信号。所以，短周期 kdj 应该作为调整仓位的信号，而长周期 kdj 作为清仓的信号。

**参考**

1. [知乎话题：如何正确理解 KDJ](https://www.zhihu.com/question/27652388)
2. [知乎@股海老张：KDJ 的详细图解和相关指示意义](https://zhuanlan.zhihu.com/p/99364915)
